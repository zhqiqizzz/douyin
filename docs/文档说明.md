# 开发文档 (Development Documentation)

本文档详细记录了 Douyin Clone 项目的架构设计、核心功能实现细节以及状态管理方案。

## 1. 项目架构

项目基于 React 18 + TypeScript + Vite 构建，采用组件化开发模式。

### 目录结构说明

```
src/
├── assets/             # 静态资源文件 (图片、图标等)
├── components/         # 公共组件
│   ├── CommentDrawer.tsx   # 评论抽屉组件
│   ├── CommentList.tsx     # 评论列表组件
│   ├── InteractionPanel.tsx# 右侧交互面板 (点赞、评论、分享)
│   ├── LoadingSpinner.tsx  # 加载动画
│   ├── SearchBar.tsx       # 顶部搜索栏
│   ├── SideBar.tsx         # 左侧导航栏 (目前集成在 Home.tsx 中)
│   ├── VideoControl.tsx    # 底部视频控制栏 (自动播放、清屏)
│   ├── VideoInfo.tsx       # 底部视频信息 (作者、标题、音乐)
│   ├── VideoPlayer.tsx     # 视频播放器封装 (基于 xgplayer)
│   └── VolumeControl.tsx   # 音量控制组件
├── hooks/              # 自定义 Hooks
│   └── useKeyboardShortcuts.ts # 键盘快捷键逻辑
├── mock/               # 模拟数据
│   ├── commentData.ts      # 评论模拟数据
│   ├── index.ts            # 统一导出
│   └── videoData.ts        # 视频列表模拟数据
├── pages/              # 页面组件
│   └── Home.tsx            # 首页 (核心页面)
├── store/              # Jotai 全局状态管理
│   ├── commentStore.ts     # 评论相关状态
│   ├── interactionStore.ts # 交互状态 (点赞、关注等)
│   ├── playerStore.ts      # 播放器状态 (播放、暂停、进度)
│   └── videoStore.ts       # 视频流状态 (当前视频、切换逻辑)
├── types/              # TypeScript 类型定义
│   └── index.ts            # 核心接口定义 (VideoItem, CommentItem 等)
├── utils/              # 工具函数
│   ├── formatNumber.ts     # 数字格式化 (如 1.2w)
│   ├── mockRequest.ts      # 模拟异步请求
│   └── shareUtils.ts       # 分享功能工具
├── App.tsx             # 根组件 (配置 Provider)
└── main.tsx            # 入口文件
```

## 2. 核心模块详解

### 2.1 视频播放模块 (`VideoPlayer.tsx`)

- **核心库**: `xgplayer`
- **实现逻辑**:
  - 使用 `useRef` 获取 DOM 容器。
  - 在 `useEffect` 中初始化 `Player` 实例。
  - 监听播放器事件 (`play`, `pause`, `timeupdate`, `ended`) 并同步到 Jotai Store (`playerStore`)。
  - 支持自动播放、循环播放配置。
  - **动态背景**: 在播放器内部创建一个 Canvas，实时绘制视频帧并进行模糊处理 ，作为视频背景，提供沉浸式体验。支持全屏模式下的背景显示。

### 2.2 视频流控制 (`videoStore.ts` & `Home.tsx`)

- **状态管理**:
  - `videoListAtom`: 存储视频列表数据。
  - `currentVideoIndexAtom`: 当前播放视频的索引。
  - `currentVideoAtom`: 派生状态，根据索引获取当前视频对象。
- **切换逻辑**:
  - `nextVideoAtom`: Action Atom，计算下一个索引（循环）。
  - `prevVideoAtom`: Action Atom，计算上一个索引（循环）。
- **UI 实现**:
  - `Home.tsx` 中监听 `currentVideo` 变化，动态渲染 `VideoPlayer`。
  - 右侧提供上下切换按钮。

### 2.3 交互系统 (`interactionStore.ts`)

- **持久化存储**: 使用 `atomWithStorage` 将状态同步到 `localStorage`。
- **功能点**:
  - **点赞**: `likedVideosAtom` (Set<string>) 存储已点赞的视频 ID。
  - **收藏**: `favoritedVideosAtom` (Set<string>) 存储已收藏的视频 ID。
  - **关注**: `followedUsersAtom` (Set<string>) 存储已关注的用户 ID。
- **优势**: 刷新页面后交互状态依然保留。

### 2.4 评论系统 (`commentStore.ts` & `CommentDrawer.tsx`)

- **数据源**: 混合了 Mock 数据和 LocalStorage。
- **功能**:
  - **虚拟评论数**: `virtualCommentCountAtom` 模拟评论数量的动态变化。
  - **本地存储**: 用户的评论会保存在 LocalStorage 中 (`video_comments_{videoId}`)。
  - **排序**: 支持 "热门" (`hot`) 和 "最新" (`time`) 排序。
- **UI**: 使用 `@douyinfe/semi-ui` 的 `Drawer` 组件，自定义样式以匹配抖音风格。

### 2.5 键盘快捷键 (`useKeyboardShortcuts.ts`)

- **监听**: `useEffect` 中监听 `keydown` 事件。
- **快捷键映射**:
  - `Space` / `K`: 播放/暂停。
  - `ArrowUp`: 上一个视频。
  - `ArrowDown`: 下一个视频。
  - `M`: 静音切换。
  - `F`: 全屏切换。
- **防冲突**: 检测 `e.target`，如果在输入框中输入则不触发快捷键。

## 3. 状态管理设计 (Jotai)

项目使用 Jotai 进行原子化状态管理，主要分为四个 Store：

| Store                | 主要 Atoms                                                                       | 描述                                                       |
| :------------------- | :------------------------------------------------------------------------------- | :--------------------------------------------------------- |
| **videoStore**       | `videoListAtom`<br>`currentVideoIndexAtom`<br>`nextVideoAtom`<br>`prevVideoAtom` | 管理视频列表数据流和当前播放索引。                         |
| **playerStore**      | `isPlayingAtom`<br>`currentTimeAtom`<br>`durationAtom`<br>`volumeAtom`           | 同步播放器的实时状态，供 UI 组件（进度条、时间显示）使用。 |
| **interactionStore** | `likedVideosAtom`<br>`favoritedVideosAtom`<br>`followedUsersAtom`                | 管理用户的交互行为，支持持久化。                           |
| **commentStore**     | `showCommentsAtom`<br>`commentsAtom`<br>`commentInputAtom`                       | 管理评论区的显示、数据加载和用户输入。                     |

## 4. 样式系统

- **Tailwind CSS**: 用于绝大多数布局和样式。
- **CSS Modules / Global CSS**: 用于一些复杂的动画或特定组件的样式覆盖。
- **配色**:
  - 背景色: `#16181F` (深色模式)
  - 主色调: 抖音红/蓝 (在图标和按钮中使用)
  - 文字: 白色 (`text-white`) 或 半透明白 (`text-[#FFFFFF80]`)

## 5. 待优化项

1.  **虚拟列表**: 目前视频列表较短，未来数据量大时需引入虚拟滚动。
2.  **API 集成**: 目前使用 Mock 数据，需对接真实后端 API。
